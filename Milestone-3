from flask import Flask, render_template, Response, jsonify, request
import cv2
import mediapipe as mp
import numpy as np
import math
from ctypes import cast, POINTER
from comtypes import CLSCTX_ALL
from pycaw.pycaw import AudioUtilities, IAudioEndpointVolume
import time

app = Flask(__name__)

devices = AudioUtilities.GetSpeakers()
interface = devices.Activate(IAudioEndpointVolume._iid_, CLSCTX_ALL, None)
volume = cast(interface, POINTER(IAudioEndpointVolume))
volRange = volume.GetVolumeRange()
minVol = volRange[0]
maxVol = volRange[1]
current_vol = 0
current_distance = 0
mute_status = False
start_time = time.time()

mpHands = mp.solutions.hands
hands = mpHands.Hands(max_num_hands=1, min_detection_confidence=0.7)
mpDraw = mp.solutions.drawing_utils

cap = cv2.VideoCapture(0)

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/get_volume')
def get_volume():
    elapsed_time = int(time.time() - start_time)
    return jsonify({
        "vol": 0 if mute_status else int(current_vol),
        "dist": int(current_distance),
        "elapsed": elapsed_time
    })

@app.route('/set_mute')
def set_mute():
    global mute_status
    mute_status = request.args.get('mute') == 'true'
    if mute_status:
        volume.SetMasterVolumeLevel(minVol, None)
    return jsonify({"mute": mute_status})

@app.route('/set_preset')
def set_preset():
    global current_vol
    preset = int(request.args.get('value', 50))
    vol = np.interp(preset, [0, 100], [minVol, maxVol])
    volume.SetMasterVolumeLevel(vol, None)
    current_vol = preset
    return jsonify({"vol": current_vol})

@app.route('/video_feed')
def video_feed():
    return Response(gen_frames(), mimetype='multipart/x-mixed-replace; boundary=frame')

def gen_frames():
    global current_vol, current_distance

    scale_percent = 100
    hand_landmark_style = mp.solutions.drawing_utils.DrawingSpec(color=(0,255,0), thickness=2, circle_radius=4)
    hand_connection_style = mp.solutions.drawing_utils.DrawingSpec(color=(0,0,255), thickness=2, circle_radius=2)

    while True:
        success, img = cap.read()
        if not success:
            break

        width = int(img.shape[1] * scale_percent / 100)
        height = int(img.shape[0] * scale_percent / 100)
        img = cv2.resize(img, (width, height))

        imgRGB = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)
        results = hands.process(imgRGB)

        if results.multi_hand_landmarks:
            for handLms in results.multi_hand_landmarks:
                mpDraw.draw_landmarks(
                    img, handLms, mp.solutions.hands.HAND_CONNECTIONS,
                    landmark_drawing_spec=hand_landmark_style,
                    connection_drawing_spec=hand_connection_style
                )

                lmList = []
                for id, lm in enumerate(handLms.landmark):
                    h, w, c = img.shape
                    cx, cy = int(lm.x * w), int(lm.y * h)
                    lmList.append((id, cx, cy))

                if lmList:
                    x1, y1 = lmList[4][1], lmList[4][2]  
                    x2, y2 = lmList[8][1], lmList[8][2]  
                    dist = math.hypot(x2 - x1, y2 - y1)
                    current_distance = dist

                    vol = np.interp(dist, [20, 200], [minVol, maxVol])
                    if not mute_status:
                        volume.SetMasterVolumeLevel(vol, None)
                        current_vol = int(np.interp(dist, [20, 200], [0, 100]))
                    else:
                        current_vol = 0

                    cv2.circle(img, (x1, y1), 8, (255, 0, 255), cv2.FILLED)
                    cv2.circle(img, (x2, y2), 8, (255, 0, 255), cv2.FILLED)
                    cv2.line(img, (x1, y1), (x2, y2), (255, 0, 255), 3)

        if current_vol > 70:
            glow = cv2.addWeighted(img, 0.7, np.full_like(img, (0,100,255)), 0.3, 0)
            img = glow

        ret, buffer = cv2.imencode('.jpg', img)
        frame = buffer.tobytes()
        yield (b'--frame\r\n'
               b'Content-Type: image/jpeg\r\n\r\n' + frame + b'\r\n')

if __name__ == "__main__":
    app.run(host='0.0.0.0', port=5000)
